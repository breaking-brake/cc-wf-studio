# Tasks: MCP Node Natural Language Mode

**Input**: Design documents from `/specs/001-mcp-natural-language-mode/`
**Prerequisites**: plan.md, spec.md, research.md, data-model.md, contracts/

**Tests**: 手動E2Eテストのみ実施。各フェーズ完了時に開発者による手動E2Eテストを行う。

**Organization**: タスクはユーザーストーリーごとにグループ化され、各ストーリーを独立して実装・テスト可能にする。

## Format: `[ID] [P?] [Story] Description`

- **[P]**: 並列実行可能（異なるファイル、依存関係なし）
- **[Story]**: タスクが属するユーザーストーリー（例: US1, US2, US3, US4）
- 説明には正確なファイルパスを含める

## 進捗管理

**重要**: タスク完了時は、`- [ ]` を `- [x]` に変更してマークしてください。

例:
```markdown
- [ ] T001 未完了のタスク
- [x] T002 完了したタスク
```

これにより、実装の進捗を可視化できます。

---

## Phase 1: セットアップ（共通インフラストラクチャ）

**目的**: プロジェクトの初期化と基本構造の確立

- [ ] T001 既存のMCPノード実装を確認し、拡張ポイントを特定する
- [ ] T002 [P] TypeScript型定義の計画を確認（src/shared/types/mcp-node.ts拡張）
- [ ] T003 [P] 国際化リソースファイルの準備を確認（5言語対応）

---

## Phase 2: 基盤（すべてのストーリーのブロック前提条件）

**目的**: すべてのユーザーストーリーの実装開始前に完了必須のコアインフラストラクチャ

**⚠️ 重要**: このフェーズが完了するまで、ユーザーストーリーの作業を開始できません

- [ ] T004 McpNodeMode型定義をsrc/shared/types/mcp-node.tsに追加
- [ ] T005 [P] NaturalLanguageParamConfig インターフェースをsrc/shared/types/mcp-node.tsに追加
- [ ] T006 [P] FullNaturalLanguageConfig インターフェースをsrc/shared/types/mcp-node.tsに追加
- [ ] T007 [P] PreservedDetailedConfig インターフェースをsrc/shared/types/mcp-node.tsに追加
- [ ] T008 McpNodeData インターフェースを拡張（mode, naturalLanguageParamConfig, fullNaturalLanguageConfig, preservedDetailedConfigフィールド追加）
- [ ] T009 [P] ModeExportMetadata型定義（discriminated union）をsrc/shared/types/mcp-node.tsに追加
- [ ] T010 既存のMcpNodeData正規化関数を更新（mode未定義時に'detailed'をデフォルト設定）
- [ ] T011 [P] 国際化リソースを5言語（en, ja, ko, zh-CN, zh-TW）に追加（モード名、説明、エラーメッセージ）

**チェックポイント**: 基盤準備完了 - ユーザーストーリーの実装を並列開始可能

---

## Phase 3: User Story 1 - モード選択機能 (Priority: P1) 🎯 MVP

**ゴール**: ユーザーがMCPノード設定時に3つの構成モード（詳細、自然言語パラメータ、完全自然言語）から選択できるようにする

**独立テスト**: MCPノード設定ダイアログを開き、3つのモードオプションが明確な説明付きで表示されることを確認。各モードを選択し、UIが選択されたモードの設定要件を反映して変更されることを確認。

### User Story 1 の実装

- [ ] T012 [P] [US1] ModeSelectionStepコンポーネントを作成（src/webview/src/components/mode-selection/ModeSelectionStep.tsx）
- [ ] T013 [P] [US1] モード選択カード用のスタイルを追加（Material Design風レイアウト）
- [ ] T014 [US1] 既存のMcpNodeEditDialogを拡張してモード選択ステップを最初のステップとして追加（src/webview/src/components/dialogs/McpNodeEditDialog.tsx）
- [ ] T015 [US1] useMcpNodeWizard カスタムフックを作成（ウィザード状態管理、ステップ検証、ナビゲーション）
- [ ] T016 [US1] モード選択に応じた条件付きUI表示ロジックを実装
- [ ] T017 [P] [US1] 各モードのツールチップと説明テキストを国際化
- [ ] T018 [US1] キーボードナビゲーションとARIA属性を実装（role="radiogroup", aria-describedby）
- [ ] T019 [US1] 既存ノード編集時の現在モード表示とモード切り替え機能を実装
- [ ] T020 [US1] モード切り替え時の警告ダイアログを実装（データ保存の説明）

### User Story 1 の手動E2Eテスト

- [ ] T021 [US1] **手動E2E**: 新規MCPノード作成時にモード選択ダイアログが3つのオプション表示で開くことを確認
- [ ] T022 [US1] **手動E2E**: 各モードオプションにホバーしたときにツールチップが表示されることを確認
- [ ] T023 [US1] **手動E2E**: 詳細モード選択時に既存のサーバー選択→ツール選択→パラメータ設定UIに進むことを確認
- [ ] T024 [US1] **手動E2E**: 自然言語パラメータモード選択時にサーバー選択→ツール選択→自然言語入力UIに進むことを確認
- [ ] T025 [US1] **手動E2E**: 完全自然言語モード選択時にサーバー選択→自然言語入力UI（ツール選択スキップ）に進むことを確認
- [ ] T026 [US1] **手動E2E**: 既存ノード編集時に現在のモードが表示され、モード切り替えが可能で設定データが保存されることを確認

**チェックポイント**: この時点でUser Story 1が完全に機能し、独立してテスト可能であること

---

## Phase 4: User Story 2 - 自然言語パラメータモードでのMCPノード設定 (Priority: P2)

**ゴール**: ユーザーが個別のパラメータフィールドを埋める代わりに自然言語で達成したいことを記述できるようにする

**独立テスト**: MCPサーバーとツールを選択し、タスクの自然言語説明を入力し、ノードを保存し、ワークフローをエクスポートして、エクスポートされたスラッシュコマンドに選択されたツールと自然言語説明の両方が含まれることを確認。

### User Story 2 の実装

- [ ] T027 [P] [US2] NaturalLanguageInputFieldコンポーネントを作成（src/webview/src/components/mode-selection/NaturalLanguageInputField.tsx）
- [ ] T028 [P] [US2] 自然言語バリデーター関数を作成（src/webview/src/services/validation/natural-language-validator.ts、最小長10文字、debounce 300ms）
- [ ] T029 [US2] McpNodeEditDialogに自然言語パラメータモード用の設定ステップを追加
- [ ] T030 [US2] サーバー＋ツール選択後の自然言語説明フィールドを実装（プレースホルダー、検証、エラーメッセージ）
- [ ] T031 [US2] 自然言語パラメータモードでノード保存時にmode、serverId、toolName、naturalLanguageParamConfigを保存
- [ ] T032 [P] [US2] 自然言語説明が最小長未満の場合のエラーメッセージを国際化（MCP_NL_DESC_TOO_SHORT）
- [ ] T033 [US2] ワークフローストアを拡張して自然言語パラメータモードデータを処理（src/webview/src/stores/workflow-store.ts）

### User Story 2 の手動E2Eテスト

- [ ] T034 [US2] **手動E2E**: 自然言語パラメータモード選択後、サーバー＋ツール選択時に「何をしたいか記述」テキストエリアが表示されることを確認
- [ ] T035 [US2] **手動E2E**: 自然言語説明入力時に最小長検証（10文字）が機能し、エラーメッセージが表示されることを確認
- [ ] T036 [US2] **手動E2E**: 有効な自然言語説明でノード保存時にmode、serverId、toolName、descriptionが正しく保存されることを確認
- [ ] T037 [US2] **手動E2E**: 保存されたノードを再度開いたときに自然言語説明が表示されることを確認

**チェックポイント**: この時点でUser Story 1とUser Story 2の両方が独立して機能すること

---

## Phase 5: User Story 3 - 完全自然言語モードでのMCPノード設定 (Priority: P3)

**ゴール**: 初心者ユーザーが特定のツールを選択せずに達成したいことを記述するだけで済むようにする

**独立テスト**: MCPサーバーを選択し、ツールを選択せずに自然言語タスク説明を入力し、ノードを保存し、ワークフローをエクスポートして、エクスポートされたスラッシュコマンドにサーバーID、利用可能ツールリスト、自然言語タスク説明が含まれることを確認。

### User Story 3 の実装

- [ ] T038 [P] [US3] MCP cache serviceを拡張して選択されたサーバーから利用可能ツールを取得・キャッシュ（src/extension/services/mcp-cache-service.ts）
- [ ] T039 [US3] McpNodeEditDialogに完全自然言語モード用の設定フローを追加（ツール選択ステップをスキップ）
- [ ] T040 [US3] サーバー選択後のタスク説明フィールドを実装（最小長20文字検証）
- [ ] T041 [US3] ノード保存時に選択されたサーバーから利用可能ツールリストを取得して保存
- [ ] T042 [US3] 完全自然言語モードでノード保存時にmode、serverId、fullNaturalLanguageConfig（taskDescription、availableTools、timestamp）を保存
- [ ] T043 [P] [US3] ModeIndicatorBadgeコンポーネントを作成（キャンバス上のビジュアルインジケーター、src/webview/src/components/mode-selection/ModeIndicatorBadge.tsx）
- [ ] T044 [US3] 既存のMcpNodeComponentを拡張してモードバッジを表示（src/webview/src/components/nodes/McpNodeComponent.tsx）
- [ ] T045 [P] [US3] モードアイコン定義（detailed=⚙️、naturalLanguageParam=◐、fullNaturalLanguage=●）
- [ ] T046 [US3] ワークフローストアを拡張して完全自然言語モードデータを処理

### User Story 3 の手動E2Eテスト

- [ ] T047 [US3] **手動E2E**: 完全自然言語モード選択後、サーバー選択時にツール選択がスキップされ、タスク説明フィールドが表示されることを確認
- [ ] T048 [US3] **手動E2E**: タスク説明入力時に最小長検証（20文字）が機能することを確認
- [ ] T049 [US3] **手動E2E**: 有効なタスク説明でノード保存時にmode、serverId、taskDescription、availableToolsが正しく保存されることを確認
- [ ] T050 [US3] **手動E2E**: キャンバス上の完全自然言語モードノードに動的ツール選択を示すビジュアルインジケーター（●バッジ）が表示されることを確認
- [ ] T051 [US3] **手動E2E**: バッジにホバーしたときにモード説明が表示されることを確認

**チェックポイント**: すべてのユーザーストーリー（US1、US2、US3）が独立して機能すること

---

## Phase 6: User Story 4 - 自然言語設定を実行可能なスラッシュコマンドにエクスポート (Priority: P2)

**ゴール**: 自然言語MCPノードを含むワークフローがClaude Codeが実行可能なスラッシュコマンドとしてエクスポートされるようにする

**独立テスト**: 3つのモードすべてでMCPノードを含むワークフローを作成し、各ワークフローをスラッシュコマンドにエクスポートし、エクスポートされたコマンドファイルを確認して、各ワークフローにClaude Codeがユーザーの意図を解釈するための適切なメタデータと指示が含まれることを確認。

### User Story 4 の実装

- [ ] T052 [P] [US4] 詳細モード用のエクスポートフォーマッター関数を作成（既存フォーマットを使用、src/extension/services/export-service.ts）
- [ ] T053 [P] [US4] 自然言語パラメータモード用のエクスポートフォーマッター関数を作成（ツール名、パラメータスキーマ、自然言語説明、Claude Code指示を含む）
- [ ] T054 [P] [US4] 完全自然言語モード用のエクスポートフォーマッター関数を作成（サーバーID、利用可能ツールリスト、タスク説明、Claude Code指示を含む）
- [ ] T055 [US4] 既存のgenerateSlashCommandFile関数を拡張してMCPノードのモードを検出しモード別フォーマッターを呼び出す
- [ ] T056 [US4] 自然言語パラメータモード用のエクスポートメタデータHTMLコメント形式を実装
- [ ] T057 [US4] 完全自然言語モード用のエクスポートメタデータHTMLコメント形式を実装
- [ ] T058 [US4] ワークフロー検証を拡張してモード別設定の整合性を確認（src/extension/utils/validate-workflow.ts）
- [ ] T059 [P] [US4] エクスポートエラーメッセージを国際化（モード設定不一致、サーバー利用不可など）

### User Story 4 の手動E2Eテスト

- [ ] T060 [US4] **手動E2E**: 詳細モードMCPノードを含むワークフローのエクスポート時に、スラッシュコマンドに明示的なツール名とパラメータキー・バリューペアが含まれることを確認
- [ ] T061 [US4] **手動E2E**: 自然言語パラメータモードMCPノードを含むワークフローのエクスポート時に、ツール名、パラメータスキーマ、自然言語説明、Claude Code指示が含まれることを確認
- [ ] T062 [US4] **手動E2E**: 完全自然言語モードMCPノードを含むワークフローのエクスポート時に、サーバーID、利用可能ツールリスト、タスク説明、Claude Code指示が含まれることを確認
- [ ] T063 [US4] **手動E2E**: 異なるモードの複数MCPノードを含むワークフローのエクスポート時に、各ノードのエクスポートフォーマットがそのモードを正しく反映することを確認
- [ ] T064 [US4] **手動E2E**: エクスポートされたスラッシュコマンドファイルをテキストエディタで開き、メタデータとフォーマットが正しいことを確認

**チェックポイント**: すべてのユーザーストーリー（US1、US2、US3、US4）が完全に機能し、相互運用可能であること

---

## Phase 7: 統合とポリッシュ

**目的**: 複数のユーザーストーリーに影響する改善

- [ ] T065 [P] モード切り替え時のデータ保存ロジックを実装（詳細→自然言語時にparameterValuesをpreservedDetailedConfigに保存）
- [ ] T066 [P] モード切り替え時のデータ復元ロジックを実装（自然言語→詳細時にpreservedDetailedConfigから復元）
- [ ] T067 後方互換性の検証（v1.2.0ワークフローがmode='detailed'としてロードされることを確認）
- [ ] T068 [P] パフォーマンス検証（モード選択UI<200ms、検証<100ms、エクスポート<1s）
- [ ] T069 [P] アクセシビリティ検証（キーボードナビゲーション、ARIAラベル、スクリーンリーダー対応）
- [ ] T070 [P] すべてのUIコンポーネントの国際化を確認（5言語）
- [ ] T071 [P] エラーハンドリングとエラーメッセージの一貫性を確認（3要素形式: 何が・なぜ・どうする）
- [ ] T072 [P] quickstart.mdに記載されたシナリオを実行して検証
- [ ] T073 コード品質チェック（ESLint、Prettier、TypeScript型チェック）
- [ ] T074 [P] JSDocコメントをすべての新規パブリックインターフェースに追加

### 統合の手動E2Eテスト

- [ ] T075 **手動E2E**: 詳細モードから自然言語パラメータモードに切り替え、parameterValuesが保存され、詳細モードに戻したときに復元されることを確認
- [ ] T076 **手動E2E**: 詳細モードから完全自然言語モードに切り替え、parameterValuesが保存され、詳細モードに戻したときに復元されることを確認
- [ ] T077 **手動E2E**: 自然言語パラメータモードと完全自然言語モードの間で切り替え、両方の自然言語説明が保存されることを確認
- [ ] T078 **手動E2E**: v1.2.0形式のワークフローをロードして、すべてのMCPノードがmode='detailed'でロードされることを確認
- [ ] T079 **手動E2E**: 各モードで50個のMCPノードを含むワークフローを作成し、パフォーマンス目標（UI応答性<200ms）が満たされることを確認
- [ ] T080 **手動E2E**: キーボードのみを使用してモード選択、設定、保存を行えることを確認
- [ ] T081 **手動E2E**: すべての5言語（en, ja, ko, zh-CN, zh-TW）でUIを表示し、翻訳が適切であることを確認

---

## 依存関係と実行順序

### フェーズ依存関係

- **セットアップ（Phase 1）**: 依存関係なし - すぐに開始可能
- **基盤（Phase 2）**: セットアップ完了に依存 - すべてのユーザーストーリーをブロック
- **ユーザーストーリー（Phase 3-6）**: すべて基盤フェーズ完了に依存
  - ユーザーストーリーはその後並列に進行可能（人員が確保されている場合）
  - または優先順序で順次進行（P1 → P2/P4 → P3）
- **統合とポリッシュ（Phase 7）**: すべての希望するユーザーストーリーが完了に依存

### ユーザーストーリー依存関係

- **User Story 1 (P1)**: 基盤（Phase 2）後に開始可能 - 他ストーリーへの依存なし
- **User Story 2 (P2)**: 基盤（Phase 2）後に開始可能 - US1と統合可能だが独立してテスト可能
- **User Story 3 (P3)**: 基盤（Phase 2）後に開始可能 - US1/US2と統合可能だが独立してテスト可能
- **User Story 4 (P2)**: US1, US2, US3の実装完了後に開始（エクスポート機能はすべてのモードに依存）

### 各ユーザーストーリー内

- 型定義とインターフェースが最初
- UIコンポーネント実装
- 統合とデータフロー
- ストーリー完了後に手動E2Eテスト実施
- 次の優先順位に移る前にストーリー完了

### 並列実行の機会

- すべてのセットアップタスク（[P]マーク付き）は並列実行可能
- すべての基盤タスク（[P]マーク付き）はPhase 2内で並列実行可能
- 基盤フェーズ完了後、US1とUS2は並列開始可能（チーム容量による）
- ストーリー内のモデル（[P]マーク付き）は並列実行可能
- 異なるユーザーストーリーは異なるチームメンバーが並列作業可能

---

## 並列実行例: User Story 1

```bash
# User Story 1のUIコンポーネントをまとめて起動:
Task: "ModeSelectionStepコンポーネントを作成（src/webview/src/components/mode-selection/ModeSelectionStep.tsx）"
Task: "モード選択カード用のスタイルを追加（Material Design風レイアウト）"
```

---

## 並列実行例: User Story 4

```bash
# User Story 4のエクスポートフォーマッター関数をまとめて起動:
Task: "詳細モード用のエクスポートフォーマッター関数を作成（src/extension/services/export-service.ts）"
Task: "自然言語パラメータモード用のエクスポートフォーマッター関数を作成"
Task: "完全自然言語モード用のエクスポートフォーマッター関数を作成"
```

---

## 実装戦略

### MVPファースト（User Story 1のみ）

1. Phase 1: セットアップを完了
2. Phase 2: 基盤を完了（重要 - すべてのストーリーをブロック）
3. Phase 3: User Story 1を完了
4. **停止して検証**: User Story 1を独立してテスト
5. 準備ができたらデプロイ/デモ

### 段階的デリバリー

1. セットアップ + 基盤を完了 → 基盤準備完了
2. User Story 1を追加 → 独立してテスト → デプロイ/デモ（MVP!）
3. User Story 2を追加 → 独立してテスト → デプロイ/デモ
4. User Story 4を追加（エクスポート機能） → 独立してテスト → デプロイ/デモ
5. User Story 3を追加 → 独立してテスト → デプロイ/デモ
6. 各ストーリーが前のストーリーを壊さずに価値を追加

### 並列チーム戦略

複数の開発者がいる場合:

1. チーム全体でセットアップ + 基盤を完了
2. 基盤完了後:
   - 開発者A: User Story 1
   - 開発者B: User Story 2
   - 基礎完了後、開発者C: User Story 4（US1, US2完了を待つ）
3. US1, US2, US4完了後、開発者D: User Story 3
4. ストーリーを独立して完了・統合

---

## 注意事項

- [P]タスク = 異なるファイル、依存関係なし
- [Story]ラベルはタスクを特定のユーザーストーリーにマップし、トレーサビリティを確保
- 各ユーザーストーリーは独立して完了・テスト可能であること
- 各タスクまたは論理グループ後にコミット
- 各チェックポイントで停止してストーリーを独立検証
- 避けるべきこと: 曖昧なタスク、同じファイルの競合、ストーリーの独立性を壊す相互依存

---

## タスクサマリー

**総タスク数**: 81
**ユーザーストーリー別タスク数**:
- User Story 1 (P1): 15タスク（実装10 + 手動E2E 6）
- User Story 2 (P2): 11タスク（実装7 + 手動E2E 4）
- User Story 3 (P3): 14タスク（実装9 + 手動E2E 5）
- User Story 4 (P2): 13タスク（実装8 + 手動E2E 5）
- セットアップ: 3タスク
- 基盤: 8タスク
- 統合とポリッシュ: 17タスク（実装10 + 手動E2E 7）

**並列実行機会**: 42タスクが[P]マークで並列実行可能

**独立テスト基準**: 各ユーザーストーリー（US1-US4）に独立テスト基準が定義され、手動E2Eテストタスクが含まれる

**推奨MVPスコープ**: User Story 1（モード選択機能）のみ
